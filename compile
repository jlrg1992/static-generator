#!/bin/bash
# A script to generate a blog from markdown files
# Dependencies: Pandoc
#  

# Reset directory
folder="${1:-blog}"
cd `dirname $0`
rm -rf ../$folder/*
cp -R ./assets/* ../$folder


compiling-posts-and-feed(){

# Getting posts metadata
  while read VAREXT
  do
    declare -g "$VAREXT"
  done <<< $(sed -n '/^\-\-\-$/,/^\-\-\-$/{/^\-\-\-$/d ; s/: /=/g ; p}' ../markdown-$folder/$1)

# Create html 
	sed "s/momotitlemomo/${title}/g
    s/momosubtitlemomo/${subtitle}/g
		s/momodatemomo/${date}/g" ./templates/header.html ./templates/post-header.html > ../$folder/${1%.md}.html
	pandoc "../markdown-$folder/$1" >> ../$folder/${1%.md}.html
	cat templates/footer.html >> ../$folder/${1%.md}.html

# Create index feed
	sed "s/momotitlemomo/${title}/g
		s/momosubtitlemomo/${subtitle}/g
		s/momolinkmomo/${1%.md}.html/g
		s/momodatemomo/${date}/ g" templates/feed.html >> ../$folder/index.html
}


# Compiling metadata to index.html
sed "s/momotitlemomo/Inicio/g" templates/header.html templates/index-header.html > ../$folder/index.html

# Looping md
for f in `ls -t ../markdown-$folder`
do
    compiling-posts-and-feed $f
done

# Index footer
cat templates/footer.html >> ../$folder/index.html

# Wanna commit?
read -p "Do want to push (y/n) " PUSH

if [ "$PUSH" = "y" ]
then
    echo "Pushing $folder"
    cd ../$folder
    read -p "Insert commit message: " LOL
    git add -A
    git commit -m "$LOL"
    git push

    echo "Pushing markdown-$folder"
    cd ../markdown-$folder
    git add -A
    git commit -m "$LOL"
    git push
fi
